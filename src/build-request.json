{
  "kind": "build_request",
  "title": "Regenerate backend authorization modules to stop canister crash",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Create valid, non-empty Motoko implementations for the missing authorization modules at `backend/authorization/access-control.mo` and `backend/authorization/MixinAuthorization.mo` so the backend canister compiles and no longer traps on initialization.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-1",
          "msg-2",
          "msg-3"
        ],
        "quotes": [
          "Backend Canister Stopped",
          "The missing modules are:\n- backend/authorization/access-control.mo\n- backend/authorization/MixinAuthorization.mo",
          "regenerate the authorization modules"
        ]
      },
      "acceptanceCriteria": [
        "`dfx build` (or equivalent Caffeine build) succeeds with no missing-module or missing-function errors.",
        "Backend canister installs and remains running (no immediate trap on initialization).",
        "The frontend startup health check no longer reports 'Backend canister is stopped' when the backend is deployed correctly."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Implement role-based authorization using the confirmed role structure: admin, editor, viewer. Ensure the authorization API matches how `backend/main.mo` calls it (e.g., `AccessControl.initState()`, `AccessControl.hasPermission(state, caller, #admin)`, `AccessControl.hasPermission(state, caller, #user)`, and `AccessControl.isAdmin(state, caller)`), and ensure `include MixinAuthorization(accessControlState);` composes correctly in `backend/main.mo`.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-4",
          "msg-5"
        ],
        "quotes": [
          "Should the regenerated authorization modules use the same role structure we discussed earlier (admin, editor, viewer)",
          "yes"
        ]
      },
      "acceptanceCriteria": [
        "`backend/main.mo` compiles without changing its existing authorization call sites (`initState`, `hasPermission`, `isAdmin`, and `MixinAuthorization(...)`).",
        "Authorization checks in `backend/main.mo` continue to enforce admin-only operations (e.g., resident creation/edit/discharge/archive/delete) and user-level read operations as currently coded.",
        "Role identifiers for admin/editor/viewer exist and are usable for gating additional operations, even if `backend/main.mo` currently only gates by `#admin` and `#user`."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Ensure the authorization state is safely initialized and persistent across upgrades where applicable, following the project’s single-actor architecture (all Motoko logic in `backend/main.mo`) and without introducing additional backend services.",
      "target": "backend",
      "source": {
        "messageIds": [
          "msg-2"
        ],
        "quotes": [
          "Until those two files contain valid role‑based authorization code, the canister will stop every time."
        ]
      },
      "acceptanceCriteria": [
        "Authorization initialization is idempotent (does not trap if called more than once during typical lifecycle/deployment flows).",
        "If stable storage is used for authorization state, upgrades do not lose role assignments (or a clear default initialization behavior is provided that does not crash).",
        "No additional canisters/services are introduced; changes remain compatible with the existing single-actor backend structure."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single-actor Motoko canister; do not introduce additional backend services.",
    "Do not edit frontend immutable paths: `frontend/src/hooks/useInternetIdentity.ts`, `frontend/src/hooks/useInternetIdentity.tsx`, `frontend/src/hooks/useActor.ts`, `frontend/src/main.tsx`, and anything under `frontend/src/components/ui`.",
    "Use English for any user-facing text (e.g., trap messages)."
  ],
  "nonGoals": [
    "Redesigning the frontend UI/UX or adding new frontend features unrelated to fixing the backend canister crash.",
    "Adding third-party authentication providers (only Internet Identity is supported).",
    "Adding external databases or non-Motoko backend components."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}